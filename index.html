<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lunar & Planetary Phase Simulator</title>
  <style>
    :root{ --bg:#0b1020; --panel:#121a33; --ink:#eaf2ff; --muted:#a9b4d6; --accent:#6ea8fe; }
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--ink)}    
    .wrap{display:grid; grid-template-columns: 360px 1fr; gap:16px; height:100vh}
    .panel{background:var(--panel); padding:16px; overflow:auto; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset}
    h1{font-size:20px; margin:0 0 12px}
    h2{font-size:14px; margin:18px 0 6px; color:var(--muted); letter-spacing:.02em; font-weight:600; text-transform:uppercase}
    /* Improved alignment for labels + sliders */
label{
  display: grid;
  grid-template-columns: 1fr 190px;  /* text | slider */
  align-items: center;
  column-gap: 12px;
  margin: 8px 0;
  font-size: 14px;
}

input[type="range"]{
  width: 100%;
  accent-color: var(--accent);
}

/* Optional: slightly wider layout on large screens */
@media (min-width: 700px){
  label{ grid-template-columns: 1fr 220px; }
}    
    select, input[type="number"], input[type="datetime-local"], button{background:#0f1530; color:var(--ink); border:1px solid #243158; border-radius:8px; padding:6px 10px}
    button{cursor:pointer}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px; height:calc(100vh - 16px)}
    .card{background:var(--panel); padding:12px; border-radius:12px; position:relative; box-shadow:0 1px 0 0 rgba(255,255,255,.06) inset}
    .canvas-box{display:grid; place-items:center; height:100%}
    .stat{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .small{font-size:12px; color:var(--muted)}
    .pill{background:#0f1530; border:1px solid #27345c; border-radius:999px; padding:4px 8px; font-size:12px; color:#b9c6f1}
    .footer{position:absolute; bottom:8px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px}
    canvas{max-width:100%; height:auto}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btnrow{display:flex; gap:8px; flex-wrap:wrap}
    .hidden{display:none}
    .ok{color:#9af29a}
    .bad{color:#ff9d9d}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="panel">
      <h1>üåó Lunar & Planetary Phase Simulator</h1>
      <div class="row">
        <span class="pill">Lambertian reflection</span>
        <span class="pill">Real‚Äëtime</span>
        <span class="pill" id="testBadge">tests: pending‚Ä¶</span>
      </div>

      <h2>Preset</h2>
      <label>
        Body
        <select id="preset">
          <option value="moon">Moon (Earth observer)</option>
          <option value="venus">Venus (Earth observer, approx)</option>
          <option value="mercury">Mercury (Earth observer, approx)</option>
          <option value="exo">Custom Exoplanet (distant observer)</option>
        </select>
      </label>
      <label id="exoRow" class="hidden">
        Exoplanet preset
        <select id="exoPreset">
          <option value="custom">Custom</option>
          <option value="hd209458b">HD 209458 b ‚Äî 3.5247 d</option>
          <option value="kepler10b">Kepler‚Äë10 b ‚Äî 0.8375 d</option>
          <option value="51pegb">51 Peg b ‚Äî 4.2308 d</option>
          <option value="k2_18b">K2‚Äë18 b ‚Äî 32.94 d</option>
          <option value="wasp12b">WASP‚Äë12 b ‚Äî 1.0914 d</option>
          <option value="gj1214b">GJ 1214 b ‚Äî 1.5804 d</option>
          <option value="toi700d">TOI‚Äë700 d ‚Äî 37.43 d</option>
          <option value="lhs1140b">LHS 1140 b ‚Äî 24.737 d</option>
        </select>
      </label>
      <div id="exoInfo" class="small hidden"></div>

      <h2>Date / Time</h2>
      <label>
        Link phase to date
        <select id="link">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </label>
      <label>
        Date/Time (UTC)
        <input id="dt" type="datetime-local">
      </label>
      <div class="btnrow">
        <button id="now">Now</button>
        <button id="todayNewMoon">Nearest New Moon (approx)</button>
      </div>
      <p class="small">When linked, the simulator computes orbital phase from the selected date using real periods (Moon synodic, Venus/Mercury approximate inferior-planet cycle, exoplanet orbital period).</p>

      <h2>Geometry</h2>
      <label>
        Orbital phase (0‚Äì1)
        <input id="phase" type="range" min="0" max="1" step="0.001" value="0.12">
      </label>
      <label>
        Inclination i (¬∞)
        <input id="incl" type="range" min="0" max="90" step="1" value="60">
      </label>
      <label>
        Eccentricity e
        <input id="ecc" type="range" min="0" max="0.9" step="0.001" value="0">
      </label>
      <label>
        Arg. of periastron œâ (¬∞)
        <input id="omega" type="range" min="0" max="360" step="1" value="0">
      </label>

      <h2>Photometry</h2>
      <label>
        Geometric albedo A<sub>g</sub>
        <input id="albedo" type="range" min="0" max="1" step="0.01" value="0.3">
      </label>
      <label>
        (R<sub>p</sub>/a)
        <input id="rp_a" type="range" min="0.0001" max="0.05" step="0.0001" value="0.01">
      </label>

      <h2>Orientation</h2>
      <label>
        Position angle (¬∞)
        <input id="posang" type="range" min="-180" max="180" step="1" value="0">
      </label>
      <label>
        Observer latitude (visual twist)
        <input id="lat" type="range" min="-90" max="90" step="1" value="0">
      </label>

      <h2>Controls</h2>
      <div class="btnrow">
        <button id="play">‚ñ∂Ô∏é Animate</button>
        <button id="pause" disabled>‚è∏Ô∏é Pause</button>
        <button id="reset">Reset</button>
        <button id="savePng">Save Disk PNG</button>
        <button id="saveCsv">Export Curve CSV</button>
      </div>
      <p class="small">Tip: switch to <span class="mono">Custom Exoplanet</span> to see the <strong>phase curve</strong> update live.</p>

      <h2>Noise (Phase Curve)</h2>
      <label>
        œÉ (relative)
        <input id="noise" type="range" min="0" max="0.05" step="0.001" value="0.0">
      </label>

      <h2>Readouts</h2>
      <div class="stat">
        Illuminated fraction k = <span id="kfrac">‚Äî</span><br/>
        Phase angle Œ± = <span id="alpha">‚Äî</span>¬∞<br/>
        Reflected flux Œ¶(Œ±) = <span id="phi">‚Äî</span> (Lambert phase fn)<br/>
        Bright‚Äëlimb PA ‚âà <span id="pa">‚Äî</span>¬∞
      </div>
    </aside>

    <main class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between; align-items:center; padding:4px 2px 8px;">
          <div>
            <strong>Disk Renderer</strong>
            <div class="small">Crescent ‚Üí Gibbous ‚Üí Full (orientation set by position angle)</div>
          </div>
          <div class="pill" id="waxwan">‚Äî</div>
        </div>
        <div class="canvas-box">
          <canvas id="disk" width="600" height="600" aria-label="phase-disk"></canvas>
        </div>
        <div class="footer">
          <div>Terminology: illuminated fraction k = (1 + cos Œ±) / 2</div>
          <div class="mono">Lambert Œ¶(Œ±) = [sin Œ± + (œÄ ‚àí Œ±) cos Œ±] / œÄ</div>
        </div>
      </section>

      <section class="card">
        <div style="padding:4px 2px 8px;">
          <strong>Phase Curve (Reflected Light)</strong>
          <div class="small">Normalized reflected flux vs phase angle (0 ‚Üí œÄ)</div>
        </div>
        <div class="canvas-box">
          <canvas id="curve" width="640" height="480" aria-label="phase-curve"></canvas>
        </div>
        <div class="footer">
          <div>Flux ‚àù A<sub>g</sub> (R<sub>p</sub>/a)<sup>2</sup> ¬∑ Œ¶(Œ±)</div>
          <div class="mono" id="fluxread">F/F‚òÖ = ‚Äî</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---------- UI refs ----------
    const ui = {
      preset: document.getElementById('preset'),
      exoRow: document.getElementById('exoRow'),
      exoPreset: document.getElementById('exoPreset'),
      link: document.getElementById('link'),
      dt: document.getElementById('dt'),
      now: document.getElementById('now'),
      todayNewMoon: document.getElementById('todayNewMoon'),
      phase: document.getElementById('phase'),
      incl: document.getElementById('incl'),
      ecc: document.getElementById('ecc'),
      omega: document.getElementById('omega'),
      albedo: document.getElementById('albedo'),
      rp_a: document.getElementById('rp_a'),
      posang: document.getElementById('posang'),
      lat: document.getElementById('lat'),
      play: document.getElementById('play'),
      pause: document.getElementById('pause'),
      reset: document.getElementById('reset'),
      savePng: document.getElementById('savePng'),
      saveCsv: document.getElementById('saveCsv'),
      kfrac: document.getElementById('kfrac'),
      alpha: document.getElementById('alpha'),
      phi: document.getElementById('phi'),
      pa: document.getElementById('pa'),
      waxwan: document.getElementById('waxwan'),
      fluxread: document.getElementById('fluxread'),
      noise: document.getElementById('noise'),
      testBadge: document.getElementById('testBadge'),
    };

    const disk = document.getElementById('disk');
    const dctx = disk.getContext('2d');
    const curve = document.getElementById('curve');
    const cctx = curve.getContext('2d');

    // Proper initialization
    let anim = null; let t = 0; const computed = {alpha:null};

    function rad(d){ return d * Math.PI/180; }
    function deg(r){ return r * 180/Math.PI; }

    // ---------- Time helpers ----------
    function toJulian(date){
      const a = Math.floor((14 - (date.getUTCMonth()+1))/12);
      const y = date.getUTCFullYear() + 4800 - a;
      const m = (date.getUTCMonth()+1) + 12*a - 3;
      const JDN = date.getUTCDate() + Math.floor((153*m + 2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045;
      const dayFrac = (date.getUTCHours() - 12)/24 + date.getUTCMinutes()/1440 + date.getUTCSeconds()/86400 + date.getUTCMilliseconds()/86400000;
      return JDN + dayFrac; // JD
    }

    // Epochs & periods (approx)
    const EPOCH_J2000 = 2451545.0; // 2000-01-01 12:00 UT
    const NEW_MOON_EPOCH = 2451550.1; // ~2000-01-06 18:14 UT
    const SYNODIC_MOON = 29.530588; // days
    const VENUS_SYN = 583.92;  // days
    const MERCURY_SYN = 115.88; // days

    function phaseFromDate(date, body){
      const JD = toJulian(date);
      let period = SYNODIC_MOON; let epoch = NEW_MOON_EPOCH;
      if(body==='venus') { period = VENUS_SYN; epoch = EPOCH_J2000; }
      if(body==='mercury') { period = MERCURY_SYN; epoch = EPOCH_J2000; }
      if(body==='exo') { period = state.exoPeriodDays; epoch = EPOCH_J2000; }
      let ph = (JD - epoch)/period; ph = ph - Math.floor(ph);
      return ph; // 0 new ‚Üí 0.5 full (inferior planets visualized similarly)
    }

    // --- Approx solar & lunar longitudes for elongation (Meeus-style, low-order) ---
    function sunEclipticLongitude(JD){
      const T = (JD - 2451545.0)/36525.0;
      const L0 = 280.46646 + 36000.76983*T + 0.0003032*T*T; // mean longitude (deg)
      const M  = 357.52911 + 35999.05029*T - 0.0001537*T*T; // mean anomaly (deg)
      const C  = (1.914602 - 0.004817*T - 0.000014*T*T)*Math.sin(rad(M))
               + (0.019993 - 0.000101*T)*Math.sin(rad(2*M))
               + 0.000289*Math.sin(rad(3*M));
      let lambda = L0 + C; // apparent longitude ignoring nutation, aberration
      lambda = ((lambda%360)+360)%360; return lambda; // deg
    }
    function moonEclipticLongitude(JD){
      const T = (JD - 2451545.0)/36525.0;
      const Lp = 218.3164477 + 481267.88123421*T - 0.0015786*T*T; // mean long of Moon
      const D  = 297.8501921 + 445267.1114034*T - 0.0018819*T*T;  // mean elongation
      const M  = 357.5291092 + 35999.0502909*T - 0.0001536*T*T;   // Sun mean anomaly
      const Mp = 134.9633964 + 477198.8675055*T + 0.0087414*T*T; // Moon mean anomaly
      // Few largest periodic terms (deg)
      let lambda = Lp
        + 6.289*Math.sin(rad(Mp))
        + 1.274*Math.sin(rad(2*D - Mp))
        + 0.658*Math.sin(rad(2*D))
        + 0.214*Math.sin(rad(2*Mp))
        + 0.110*Math.sin(rad(D));
      lambda = ((lambda%360)+360)%360; return lambda; // deg
    }
    function lunarElongationAlpha(JD){
      // Compute phase angle alpha from Sun/Moon apparent ecliptic longitudes (approx)
      const lamS = sunEclipticLongitude(JD);
      const lamM = moonEclipticLongitude(JD);
      const psi = Math.abs(rad(((lamM - lamS + 540)%360)-180)); // elongation 0..œÄ
      return psi; // ~alpha for Earth observer (good first-order)
    }

    // --- RA/Dec & Position Angle (more precise bright-limb PA) ---
    function meanObliquityRad(JD){ // radians
      const eps = 23.439291 - 46.8150/3600*(JD-2451545)/36525 - 0.00059/3600*Math.pow((JD-2451545)/36525,2);
      return rad(eps);
    }
    function eclToEquatorial(lambdaDeg, betaDeg, JD){
      const eps = meanObliquityRad(JD);
      const lam = rad(lambdaDeg), bet = rad(betaDeg||0);
      const sinDec = Math.sin(bet)*Math.cos(eps) + Math.cos(bet)*Math.sin(eps)*Math.sin(lam);
      const dec = Math.asin(Math.max(-1, Math.min(1, sinDec)));
      const y = Math.sin(lam)*Math.cos(eps) - Math.tan(bet)*Math.sin(eps);
      const x = Math.cos(lam);
      let ra = Math.atan2(y, x);
      if(ra < 0) ra += 2*Math.PI;
      return {ra, dec}; // radians
    }
    function sunRaDec(JD){
      const lamS = sunEclipticLongitude(JD);
      return eclToEquatorial(lamS, 0, JD);
    }
    function moonEclipticLatitude(JD){ // deg, few dominant terms
      const T = (JD - 2451545.0)/36525.0;
      const D  = 297.8501921 + 445267.1114034*T - 0.0018819*T*T;  // mean elongation
      const M  = 357.5291092 + 35999.0502909*T - 0.0001536*T*T;   // Sun mean anomaly
      const Mp = 134.9633964 + 477198.8675055*T + 0.0087414*T*T; // Moon mean anomaly
      const F  = 93.2720950  + 483202.0175233*T - 0.0036539*T*T;  // argument of latitude
      let beta = 5.128*Math.sin(rad(F))
               + 0.280*Math.sin(rad(Mp+F))
               + 0.277*Math.sin(rad(Mp-F))
               + 0.173*Math.sin(rad(2*D-F))
               + 0.055*Math.sin(rad(2*D+F))
               + 0.046*Math.sin(rad(2*D-Mp+F));
      return beta; // deg
    }
    function moonRaDec(JD){
      const lamM = moonEclipticLongitude(JD);
      const betM = moonEclipticLatitude(JD);
      return eclToEquatorial(lamM, betM, JD);
    }
    function brightLimbPA_deg(JD){
      const S = sunRaDec(JD); const M = moonRaDec(JD);
      const dRA = S.ra - M.ra; // radians
      const num = Math.cos(S.dec)*Math.sin(dRA);
      const den = Math.sin(S.dec)*Math.cos(M.dec) - Math.cos(S.dec)*Math.sin(M.dec)*Math.cos(dRA);
      let chi = Math.atan2(num, den); // radians, measured from N toward E
      return deg(chi); // degrees
    }

    // Lambertian phase function
    function lambertPhase(alpha){
      return (Math.sin(alpha) + (Math.PI - alpha) * Math.cos(alpha)) / Math.PI;
    }

    function trueAnomalyFromMean(M, e){
      let E = M; for(let i=0;i<10;i++) E = M + e * Math.sin(E);
      const cosf = (Math.cos(E) - e) / (1 - e*Math.cos(E));
      const sinf = (Math.sqrt(1-e*e) * Math.sin(E)) / (1 - e*Math.cos(E));
      return Math.atan2(sinf, cosf);
    }

    function phaseAngleExoplanet(t, iDeg, e, omegaDeg){
      const i = rad(iDeg);
      const M = 2*Math.PI * t;
      const f = trueAnomalyFromMean(M, e);
      const omega = rad(omegaDeg);
      const cosalpha = Math.sin(i) * Math.cos(f + omega);
      let alpha = Math.acos(Math.max(-1, Math.min(1, cosalpha)));
      return {alpha, f};
    }

    function phaseAngleSynodic(t){
      // General visual mapping from synodic phase to phase angle
      // t=0 new (alpha=œÄ), t=0.5 full (alpha‚âà0)
      const M = 2*Math.PI * t;
      const a = Math.acos(-Math.cos(M));
      return {alpha:a};
    }

    function illuminatedFraction(alpha){ return 0.5 * (1 + Math.cos(alpha)); }

    function drawDisk(alpha, posAngleDeg){
      const W = disk.width, H = disk.height; const R = Math.min(W,H)*0.38;
      const cx = W/2, cy = H/2;
      dctx.clearRect(0,0,W,H);
      dctx.fillStyle = '#0b1020'; dctx.fillRect(0,0,W,H);
      dctx.save(); dctx.translate(cx, cy); dctx.rotate(rad(posAngleDeg));
      dctx.fillStyle = '#0e1327'; dctx.beginPath(); dctx.arc(0,0,R,0,2*Math.PI); dctx.fill();
      const k = illuminatedFraction(alpha); const cosA = Math.cos(alpha); const dx = R * cosA;
      dctx.globalCompositeOperation = 'source-over'; dctx.fillStyle = '#e6edf8'; dctx.beginPath(); dctx.arc(-dx,0,R,0,2*Math.PI); dctx.fill();
      const grad = dctx.createRadialGradient(0,0,R*0.2, 0,0,R); grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.45)');
      dctx.globalCompositeOperation = 'multiply'; dctx.fillStyle = grad; dctx.beginPath(); dctx.arc(0,0,R,0,2*Math.PI); dctx.fill();
      dctx.globalCompositeOperation = 'lighter'; dctx.strokeStyle = 'rgba(255,255,255,0.35)'; dctx.lineWidth = 1.2; dctx.beginPath(); dctx.arc(0,0,R-0.6,0,2*Math.PI); dctx.stroke();
      dctx.restore();
      const wax = Math.cos(alpha) > 0 ? 'Waxing' : 'Waning'; ui.waxwan.textContent = `${wax} ¬∑ k=${k.toFixed(3)}`;
    }

    function drawPhaseCurve(iDeg, e, omegaDeg, albedo, rp_a){
      const W = curve.width, H = curve.height; cctx.clearRect(0,0,W,H);
      cctx.fillStyle = '#0b1020'; cctx.fillRect(0,0,W,H);
      cctx.strokeStyle = '#30406f'; cctx.lineWidth = 1; cctx.beginPath(); cctx.moveTo(50, H-40); cctx.lineTo(W-20, H-40); cctx.moveTo(50,20); cctx.lineTo(50,H-40); cctx.stroke();
      cctx.fillStyle = '#a9b4d6'; cctx.font = '12px ui-sans-serif'; cctx.fillText('Œ± (deg)', W-60, H-20); cctx.fillText('Flux (norm.)', 10, 30);
      const N=180; let maxF=0; const pts=[];
      for(let j=0;j<=N;j++){
        const tt = j/N; const {alpha} = phaseAngleExoplanet(tt, iDeg, e, omegaDeg); const phi = lambertPhase(alpha); const F = albedo * (rp_a*rp_a) * phi; pts.push({alpha, F}); if(F>maxF) maxF=F; }
      // clean curve
      cctx.strokeStyle = '#6ea8fe'; cctx.lineWidth = 2; cctx.beginPath();
      for(let p=0;p<pts.length;p++){
        const x = 50 + (W-70) * (pts[p].alpha/Math.PI);
        const y = (H-40) - (H-60) * (pts[p].F/(maxF||1));
        if(p===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
      }
      cctx.stroke();
      // noisy samples
      const sigma = parseFloat(ui.noise.value);
      if(sigma>0){
        cctx.fillStyle = '#c7d3ff';
        for(let p=0;p<pts.length;p+=4){
          const nF = Math.max(0, pts[p].F + sigma * (Math.random()*2-1));
          const x = 50 + (W-70) * (pts[p].alpha/Math.PI);
          const y = (H-40) - (H-60) * (nF/(maxF||1));
          cctx.beginPath(); cctx.arc(x,y,2,0,2*Math.PI); cctx.fill();
        }
      }
      cctx.fillStyle = '#7e8bb2';
      for(let d=0; d<=180; d+=30){ const x = 50 + (W-70) * (rad(d)/Math.PI); cctx.fillRect(x, H-40, 1, 4); cctx.fillText(String(d), x-8, H-22); }
    }

    // ---------- State & presets ----------
    const state = { exoPeriodDays: 3.5 };
    const exoPresets = {
      custom:    {P:3.5,    albedo:0.3,  rp_a:0.01,  i:60,   e:0.0,  omega:0,  info:'Custom ‚Äî set A_g and (R_p/a) as you like.'},
      hd209458b: {P:3.5247,  albedo:0.3,  rp_a:0.0145,i:86.6, e:0.0,  omega:0,  info:'Hot Jupiter; transiting; canonical phase-curve target.'},
      kepler10b: {P:0.8375,  albedo:0.2,  rp_a:0.012, i:84,   e:0.0,  omega:0,  info:'Ultra-short period rocky candidate; likely dark.'},
      '51pegb':  {P:4.2308,  albedo:0.35, rp_a:0.013, i:80,   e:0.0,  omega:0,  info:'First hot Jupiter discovered; non-transiting in reality.'},
      k2_18b:    {P:32.94,   albedo:0.15, rp_a:0.004, i:89.6, e:0.01, omega:90, info:'Sub-Neptune in HZ; JWST atmospheres.'},
      wasp12b:   {P:1.0914,  albedo:0.05, rp_a:0.020, i:83,   e:0.0,  omega:0,  info:'Very hot Jupiter; likely low A_g; strong thermal component.'},
      gj1214b:   {P:1.5804,  albedo:0.1,  rp_a:0.009, i:88,   e:0.0,  omega:0,  info:'Sub-Neptune; famously flat transmission spectrum.'},
      toi700d:   {P:37.43,   albedo:0.3,  rp_a:0.0035,i:89.8, e:0.0,  omega:0,  info:'Earth-sized in HZ of M dwarf.'},
      lhs1140b:  {P:24.737,  albedo:0.25, rp_a:0.0038,i:88.5, e:0.0,  omega:0,  info:'Rocky super-Earth in HZ; dense atmosphere possible.'}
    };
    const presets = {
      moon:    { mode:'moon',  i: 1.5,  e: 0.0549, omega: 318, albedo: 0.12, rp_a: 0.0092 },
      venus:   { mode:'syn',   i: 3.4,  e: 0.0068, omega: 54,  albedo: 0.77, rp_a: 0.0049 },
      mercury: { mode:'syn',   i: 7.0,  e: 0.2056, omega: 29,  albedo: 0.14, rp_a: 0.0017 },
      exo:     { mode:'exo',   i: 60,   e: 0.0,    omega: 0,   albedo: 0.3,  rp_a: 0.01, P: 3.5 }
    };

    function applyPreset(key){
      const p = presets[key]; if(!p) return;
      ui.incl.value = p.i; ui.ecc.value = p.e; ui.omega.value = p.omega; ui.albedo.value = p.albedo; ui.rp_a.value = p.rp_a;
      if(key==='exo' && p.P) state.exoPeriodDays = p.P;
      update();
    }

    // ---------- Main update ----------
    function update(){
      const linkOn = ui.link.value === 'on';
      const body = ui.preset.value;
      ui.exoRow.classList.toggle('hidden', body!=='exo');

      if(linkOn){
        let date = ui.dt.value ? new Date(ui.dt.value) : new Date();
        if(body==='moon'){
          const JD = toJulian(date);
          const a = lunarElongationAlpha(JD);
          t = ((JD - NEW_MOON_EPOCH) / SYNODIC_MOON); t = t - Math.floor(t);
          ui.phase.value = t.toFixed(3);
          computed.alpha = a;
        } else {
          t = phaseFromDate(date, body==='exo' ? 'exo' : body);
          ui.phase.value = t.toFixed(3);
          computed.alpha = null;
        }
      } else {
        t = parseFloat(ui.phase.value);
        computed.alpha = null;
      }

      const iDeg = parseFloat(ui.incl.value);
      const e = parseFloat(ui.ecc.value);
      const omegaDeg = parseFloat(ui.omega.value);
      const albedo = parseFloat(ui.albedo.value);
      const rp_a = parseFloat(ui.rp_a.value);
      const posangUser = parseFloat(ui.posang.value);
      const latTwist = parseFloat(ui.lat.value)*0.2;

      let alpha;
      if(body==='exo'){
        alpha = phaseAngleExoplanet(t, iDeg, e, omegaDeg).alpha;
      } else if(body==='moon'){
        alpha = computed.alpha ?? phaseAngleSynodic(t).alpha;
      } else {
        alpha = phaseAngleSynodic(t).alpha;
      }

      // Bright-limb position angle
      let pa = 0;
      if(body==='moon'){
        const JD = ui.dt.value ? toJulian(new Date(ui.dt.value)) : toJulian(new Date());
        pa = brightLimbPA_deg(JD);
      }

      const k = illuminatedFraction(alpha); const phi = lambertPhase(alpha);
      ui.kfrac.textContent = k.toFixed(4); ui.alpha.textContent = deg(alpha).toFixed(2); ui.phi.textContent = phi.toFixed(4); ui.pa.textContent = pa.toFixed(1);
      const flux = albedo * Math.pow(rp_a,2) * phi; ui.fluxread.textContent = `F/F‚òÖ = ${flux.toExponential(3)}`;

      const posang = posangUser + latTwist + pa; // apply orientation
      drawDisk(alpha, posang); drawPhaseCurve(iDeg, e, omegaDeg, albedo, rp_a);
    }

    // ---------- Animation ----------
    function tick(){ t = (t + 0.001) % 1; ui.phase.value = t.toFixed(3); update(); anim = requestAnimationFrame(tick); }
    ui.play.onclick = ()=>{ if(!anim){ anim = requestAnimationFrame(tick); ui.play.disabled=true; ui.pause.disabled=false; }}
    ui.pause.onclick = ()=>{ if(anim){ cancelAnimationFrame(anim); anim=null; ui.play.disabled=false; ui.pause.disabled=true; }}
    ui.reset.onclick = ()=>{ ui.phase.value=0.12; ui.incl.value=60; ui.ecc.value=0; ui.omega.value=0; ui.albedo.value=0.3; ui.rp_a.value=0.01; ui.posang.value=0; ui.lat.value=0; ui.link.value='on'; ui.preset.value='moon'; ui.exoPreset.value='custom'; setNow(); applyPreset('moon'); update(); }

    // ---------- Export ----------
    ui.savePng.onclick = ()=>{ const link = document.createElement('a'); link.download = 'phase_disk.png'; link.href = disk.toDataURL('image/png'); link.click(); };
    ui.saveCsv.onclick = ()=>{
      const rows = [['alpha_deg','phi_lambert','flux_rel']];
      const iDeg = parseFloat(ui.incl.value), e=parseFloat(ui.ecc.value), omegaDeg=parseFloat(ui.omega.value), A=parseFloat(ui.albedo.value), rp_a=parseFloat(ui.rp_a.value);
      const N=180;
      for(let j=0;j<=N;j++){
        const tt=j/N; const {alpha}=phaseAngleExoplanet(tt,iDeg,e,omegaDeg); const phi=lambertPhase(alpha); const F=A*(rp_a*rp_a)*phi; rows.push([deg(alpha).toFixed(6), phi.toFixed(8), F.toExponential(8)]);
      }
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download='phase_curve.csv'; link.click(); URL.revokeObjectURL(link.href);
    };

    // ---------- Date controls ----------
    function setNow(){
      const d = new Date(); // UTC assumed
      const pad = n=> String(n).padStart(2,'0');
      const iso = `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}T${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}`;
      ui.dt.value = iso;
    }
    ui.now.onclick = ()=>{ setNow(); update(); };
    ui.todayNewMoon.onclick = ()=>{ // rough: set date so phase‚âà0
      const d = new Date(); const JD = toJulian(d); const k = (JD - NEW_MOON_EPOCH)/SYNODIC_MOON; const nearest = Math.round(k); const targetJD = NEW_MOON_EPOCH + nearest*SYNODIC_MOON; const days = targetJD - JD; d.setUTCDate(d.getUTCDate() + Math.round(days));
      const pad=n=>String(n).padStart(2,'0'); const iso = `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}T12:00`; ui.dt.value = iso; update(); };

    // ---------- Bindings ----------
    [...document.querySelectorAll('input,select')].forEach(el=> el.addEventListener('input', update));
    ui.preset.addEventListener('change', ()=> { applyPreset(ui.preset.value); ui.exoRow.classList.toggle('hidden', ui.preset.value!=='exo'); });
    ui.exoPreset.addEventListener('change', ()=>{
      const ep = exoPresets[ui.exoPreset.value]; if(!ep) return;
      state.exoPeriodDays = ep.P; ui.albedo.value = ep.albedo; ui.rp_a.value = ep.rp_a; ui.incl.value = ep.i; ui.ecc.value = ep.e; ui.omega.value = ep.omega; update();
      const info = document.getElementById('exoInfo'); info.classList.remove('hidden'); info.textContent = `${ui.exoPreset.options[ui.exoPreset.selectedIndex].text} ¬∑ ${ep.info}  (A_g=${ep.albedo}, R_p/a=${ep.rp_a})`;
    });

    // ---------- Tiny self-tests (unit-style) ----------
    function approxEq(a,b,eps=1e-6){ return Math.abs(a-b) < eps }
    function runTests(){
      const results = [];
      results.push({name:'lambert(0)=1', ok: approxEq(lambertPhase(0),1)});
      results.push({name:'lambert(pi)=0', ok: approxEq(lambertPhase(Math.PI),0)});
      results.push({name:'k(0)=1', ok: approxEq(illuminatedFraction(0),1)});
      results.push({name:'k(pi)=0', ok: approxEq(illuminatedFraction(Math.PI),0)});
      // Exoplanet phase increases with time for P=10 d
      const d0 = new Date(Date.UTC(2020,0,1)); state.exoPeriodDays = 10; const p0 = phaseFromDate(d0,'exo'); const p1 = phaseFromDate(new Date(Date.UTC(2020,0,6)),'exo');
      results.push({name:'phase monotone over +5d', ok: ((p1-p0+1)%1) > 0});
      // PA sanity: for near new moon, PA should be finite and within [-180,180]
      const JD_test = 2451550.1; const paTest = brightLimbPA_deg(JD_test);
      results.push({name:'PA finite', ok: Number.isFinite(paTest)});
      results.push({name:'PA range', ok: paTest>=-180 && paTest<=180});
      const okAll = results.every(r=>r.ok);
      console.table(results);
      ui.testBadge.textContent = okAll ? 'tests: all passed' : 'tests: some failed';
      ui.testBadge.classList.toggle('ok', okAll); ui.testBadge.classList.toggle('bad', !okAll);
    }

    // ---------- Init ----------
    function init(){ setNow(); applyPreset('moon'); update(); runTests(); }
    init();
  </script>
</body>
</html>
